/* Задание 4.1

База данных содержит список аэропортов практически всех крупных городов России. В большинстве городов есть только один аэропорт. Исключение составляет */

SELECT a.city
FROM dst_project.airports AS a
GROUP BY a.city
HAVING count(a.airport_name) > 1

/* Задание 4.2 

Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и запланированных рейсах. Сколько всего статусов для рейсов определено в таблице? */

SELECT count(DISTINCT f.status)
FROM dst_project.flights AS f

/* Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в базе (статус рейса «самолёт уже вылетел и находится в воздухе»). */ 

SELECT count(f.flight_id)
FROM dst_project.flights AS f
WHERE f.status = 'Departed'


/* Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет самолет модели 733 (Boeing 777-300)? */

SELECT count(s.seat_no)
FROM dst_project.seats AS s
JOIN dst_project.aircrafts AS a ON s.aircraft_code = a.aircraft_code
WHERE a.aircraft_code = '773'


/* Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года? 
Здесь и далее состоявшийся рейс означает, что он не отменён, и самолёт прибыл в пункт назначения. */

SELECT count(f.flight_id)
FROM dst_project.flights AS f
WHERE (f.actual_arrival BETWEEN '2017-04-01' AND '2017-09-01')
  AND (f.status !='Cancelled'
       AND f.status = 'Arrived')

/* Задание 4.3 

Вопрос 1. Сколько всего рейсов было отменено по данным базы? */

SELECT count(f.flight_id)
FROM dst_project.flights AS f
WHERE f.status = 'Cancelled'


/* Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок? 

Boeing: */

SELECT count(a.model)
FROM dst_project.aircrafts AS a
WHERE a.model like 'Boeing%'

/* Sukhoi Superjet: */

SELECT count(a.model)
FROM dst_project.aircrafts AS a
WHERE a.model like 'Sukhoi Superjet%'

/* Airbus: */

SELECT count(a.model)
FROM dst_project.aircrafts AS a
WHERE a.model like 'Airbus%'


/* Вопрос 3. В какой части (частях) света находится больше аэропортов? */

SELECT count(a.timezone)
FROM dst_project.airports AS a
WHERE a.timezone like 'Asia%'

SELECT count(a.timezone)
FROM dst_project.airports AS a
WHERE a.timezone like 'Europe%' -- Определил перебирая паттерны, не смог подсчитать вместе
   

/* Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id). */

SELECT f.flight_id,
       (f.actual_arrival - f.scheduled_arrival) AS delay_arrival
FROM dst_project.flights AS f
WHERE f.actual_arrival IS NOT NULL
ORDER BY 2 DESC
LIMIT 1

/*  Задание 4.4
Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных? */

SELECT f.scheduled_departure
FROM dst_project.flights AS f
ORDER BY 1
LIMIT 1

/* Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе?  */

SELECT max(EXTRACT(EPOCH
                   FROM (f.scheduled_arrival - f.scheduled_departure)) / 60)
FROM dst_project.flights AS f

/* Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс? */

SELECT f.departure_airport,
       f.arrival_airport,
       max(EXTRACT(EPOCH
                   FROM (f.scheduled_arrival - f.scheduled_departure)) / 60)
FROM dst_project.flights AS f
GROUP BY f.departure_airport,
         f.arrival_airport,
         f.scheduled_arrival - f.scheduled_departure
ORDER BY f.scheduled_arrival - f.scheduled_departure DESC

/* Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? Секунды округляются в меньшую сторону (отбрасываются до минут).  */

SELECT avg(EXTRACT(EPOCH
                   FROM (f.scheduled_arrival - f.scheduled_departure)) / 60)
FROM dst_project.flights AS f

/* Задание 4.5

Вопрос 1. Мест какого класса у SU9 больше всего?  */

SELECT s.fare_conditions,
       count(s.seat_no) AS seat_count
FROM dst_project.seats AS s
WHERE s.aircraft_code = 'SU9'
GROUP BY s.fare_conditions
ORDER BY count(s.seat_no) DESC
LIMIT 1

/* Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю? */

SELECT min(b.total_amount)
FROM dst_project.bookings AS b

/* Вопрос 3. Какой номер места был у пассажира с id = 4313 788533? */

SELECT b.seat_no
FROM dst_project.tickets AS t
JOIN dst_project.boarding_passes AS b ON t.ticket_no = b.ticket_no
WHERE passenger_id = '4313 788533'

/* Задание 5.1

Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год? */

SELECT count(DISTINCT f.scheduled_arrival)
FROM dst_project.flights AS f
LEFT JOIN dst_project.airports AS a ON a.airport_code = f.departure_airport
WHERE (arrival_airport = 'AAQ')
  AND (status = 'Arrived')
  AND (date_part('year', actual_arrival) = 2017)
   
/* Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года? */

SELECT count(DISTINCT f.scheduled_departure)
FROM dst_project.flights AS f
LEFT JOIN dst_project.airports AS a ON a.airport_code = f.departure_airport
WHERE a.airport_name like 'Anap%'
  AND (date_part('year', actual_departure) = 2017)
  AND (date_part('month', actual_departure) in (12,
                                                1,
                                                2));
   
/* Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время. */

SELECT count(f.flight_id)
FROM dst_project.flights AS f
LEFT JOIN dst_project.airports AS a ON a.airport_code = f.departure_airport
WHERE a.airport_name like 'Anap%'
  AND f.status = 'Cancelled';
   
/* Вопрос 4. Сколько рейсов из Анапы не летают в Москву? */

SELECT count(f.flight_no)
FROM dst_project.flights AS f
WHERE f.departure_airport = 'AAQ'
  AND f.arrival_airport !='SVO'
 
/* Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест? */

SELECT DISTINCT f.aircraft_code,
                ac.model,
                a.seats
FROM dst_project.flights AS f
JOIN
  (SELECT aircraft_code,
          count(*) seats
   FROM dst_project.seats
   GROUP BY aircraft_code)AS a ON a.aircraft_code = f.aircraft_code
JOIN dst_project.aircrafts AS ac ON f.aircraft_code = ac.aircraft_code
WHERE f.departure_airport = 'AAQ'
ORDER BY a.seats DESC
LIMIT 1



/* Финальный запрос */

WITH flight AS
  (SELECT f.flight_id,
          f.flight_no,
          f.departure_airport,
          f.arrival_airport,
          f.status,
          f.aircraft_code,
          f.actual_arrival,
          f.actual_departure,
          a.model
   FROM dst_project.flights AS f
   LEFT JOIN dst_project.aircrafts AS a ON f.aircraft_code = a.aircraft_code),
     ticket AS
  (SELECT flight_id,
          sum(amount) total_amount
   FROM dst_project.ticket_flights
   GROUP BY 1),
     ticket_class AS
  (SELECT tf.flight_id,
          count(CASE
                    WHEN tf.fare_conditions = 'Economy' THEN tf.fare_conditions
                END) AS ticket_economy,
          count(CASE
                    WHEN tf.fare_conditions = 'Comfort' THEN tf.fare_conditions
                END) AS ticket_comfort,
          count(CASE
                    WHEN tf.fare_conditions = 'Business' THEN tf.fare_conditions
                END) AS ticket_business
   FROM dst_project.ticket_flights AS tf
   GROUP BY 1),
     seat_class AS
  (SELECT sc.aircraft_code,
          count(CASE
                    WHEN sc.fare_conditions = 'Economy' THEN sc.fare_conditions
                END) AS seat_economy,
          count(CASE
                    WHEN sc.fare_conditions = 'Comfort' THEN sc.fare_conditions
                END) AS seat_comfort,
          count(CASE
                    WHEN sc.fare_conditions = 'Business' THEN sc.fare_conditions
                END) AS seat_business
   FROM dst_project.seats AS sc
   GROUP BY 1)
SELECT f.flight_id,
       f.flight_no,
       f.departure_airport,
       f.arrival_airport,
       f.model,
       f.actual_arrival,
       f.actual_departure,
       tc.ticket_economy ticket_economy,
       sc.seat_economy seat_economy,
       tc.ticket_comfort ticket_comfort,
       sc.seat_comfort seat_comfort,
       tc.ticket_business ticket_business,
       sc.seat_business seat_business,
       date_part('hour', f.actual_arrival - f.actual_departure) * 60 + date_part('minute', f.actual_arrival - f.actual_departure) flight_time,
       t.total_amount
FROM flight AS f
LEFT JOIN ticket AS t ON t.flight_id = f.flight_id
LEFT JOIN ticket_class AS tc ON tc.flight_id = f.flight_id
LEFT JOIN seat_class AS sc ON sc.aircraft_code = f.aircraft_code
WHERE f.departure_airport = 'AAQ'
  AND status not in ('Cancelled')
  AND (date_part('year', actual_departure) = 2017)
  AND (date_part('month', actual_departure) in (12,
                                                1,
                                                2));